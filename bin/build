#!/usr/bin/env bash

set -eo pipefail
set -eu

start_time=$(date +%s%N)

function error() {
  echo " !     $*" >&2
  exit 1
}

function topic() {
  echo "-----> $*"
}

function indent() {
  c='s/^/       /'
  case $(uname) in
    Darwin) sed -l "$c";;
    *)      sed -u "$c";;
  esac
}

layers_dir="$1"
env_dir="$2/env"
plan_path="$3"

chrome_layer="$layers_dir/chrome"
mkdir -p "$chrome_layer"

chrome_env_dir="$chrome_layer/env"
mkdir -p "$chrome_env_dir"
echo -n "$chrome_layer/opt/google/chrome" > "$chrome_env_dir/PATH.prepend"
echo -n ":" > "$chrome_env_dir/PATH.delim"

CHROME_URL="https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb"

topic "Baixando Google Chrome"
wget -q -O /tmp/chrome.deb "$CHROME_URL" || error "Falha ao baixar o Chrome"

topic "Extraindo Google Chrome para o layer"
dpkg-deb -x /tmp/chrome.deb "$chrome_layer" || error "Falha ao extrair o Chrome"

topic "Configurando PATH no profile.d"
mkdir -p "$chrome_layer/.profile.d"
echo "export PATH=\"$chrome_layer/opt/google/chrome:\$PATH\"" > "$chrome_layer/.profile.d/chrome.sh"

topic "Gerando chrome.toml"
cat > "${chrome_layer}.toml" <<EOL
[types]
launch = true
build = true
cache = false
EOL

topic "Verificando instalação do Google Chrome"
"$chrome_layer/opt/google/chrome/google-chrome" --version || error "Google Chrome não instalado corretamente"

end_time=$(date +%s%N)
echo "Elapsed time: $(( ($end_time - $start_time) / 1000000 ))ms" | indent